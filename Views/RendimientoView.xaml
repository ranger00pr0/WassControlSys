<UserControl x:Class="WassControlSys.Views.RendimientoView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             mc:Ignorable="d" 
             d:DesignHeight="800" d:DesignWidth="800">
    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <TextBlock Grid.Row="0" Text="Rendimiento y Procesos" Style="{StaticResource HeaderTextStyle}"/>

        <!-- Monitoreo Térmico Rápido -->
        <Border Grid.Row="1" Background="{DynamicResource SurfaceBrush}" CornerRadius="12" Padding="20" Margin="0,0,0,15">
            <StackPanel>
                <Border BorderBrush="#444" BorderThickness="1" CornerRadius="8" Padding="15" HorizontalAlignment="Left" MinWidth="140">
                    <StackPanel>
                        <TextBlock Text="Procesador (CPU)" Foreground="{DynamicResource SecondaryTextBrush}" FontSize="12"/>
                        <TextBlock Text="{Binding CpuTempC, StringFormat={}{0:F1}°C}" Foreground="{DynamicResource TextBrush}" FontSize="20" FontWeight="Bold"/>
                        <TextBlock Text="{Binding ThermalAlert}" Foreground="#FF4444" FontSize="11" Margin="0,5,0,0" Visibility="{Binding ThermalAlert, Converter={StaticResource StringNotEmptyToVisibilityConverter}}"/>
                    </StackPanel>
                </Border>
            </StackPanel>
        </Border>

        <TabControl Grid.Row="2" Background="Transparent" BorderThickness="0">
            <!-- Procesos -->
            <TabItem Header="Procesos Activos">
                <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="0,12,12,12" Padding="15">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <Button Grid.Row="0" Content="Actualizar Lista" Command="{Binding RefreshProcessesCommand}" Style="{StaticResource SecondaryButtonStyle}" HorizontalAlignment="Right" Margin="0,0,0,10"/>
                        <DataGrid Grid.Row="1" ItemsSource="{Binding Processes}" AutoGenerateColumns="False" Background="Transparent" Foreground="{DynamicResource TextBrush}" BorderThickness="0" CanUserAddRows="False" SelectionMode="Single"
                                  VirtualizingStackPanel.IsVirtualizing="True" VirtualizingStackPanel.VirtualizationMode="Recycling">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="PID" Binding="{Binding Pid}" Width="60"/>
                            <DataGridTextColumn Header="Nombre" Binding="{Binding Name}" Width="*"/>
                            <DataGridTextColumn Header="Memoria (MB)" Binding="{Binding WorkingSetMb, StringFormat={}{0:F1}}" Width="100"/>
                            <DataGridTemplateColumn Header="Prioridad" Width="100">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <Button Content="+" Command="{Binding DataContext.SetProcessPriorityHighCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}" CommandParameter="{Binding}" Style="{StaticResource SecondaryButtonStyle}" Padding="8,2" ToolTip="Prioridad Alta"/>
                                            <Button Content="-" Command="{Binding DataContext.KillProcessCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}" CommandParameter="{Binding}" Style="{StaticResource DangerButtonStyle}" Padding="8,2" Margin="5,0,0,0" ToolTip="Finalizar Proceso"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                    </Grid>
                </Border>
            </TabItem>

            <!-- Servicios -->
            <TabItem Header="Servicios">
                <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="0,12,12,12" Padding="15">
                     <DataGrid ItemsSource="{Binding WindowsServices}" AutoGenerateColumns="False" Background="Transparent" Foreground="{DynamicResource TextBrush}" BorderThickness="0" CanUserAddRows="False"
                               VirtualizingStackPanel.IsVirtualizing="True" VirtualizingStackPanel.VirtualizationMode="Recycling">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Nombre" Binding="{Binding DisplayName}" Width="*"/>
                            <DataGridTextColumn Header="Estado" Binding="{Binding Status}" Width="100"/>
                            <DataGridTemplateColumn Header="Control" Width="150">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <Button Content="Iniciar" Command="{Binding DataContext.StartServiceCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}" CommandParameter="{Binding Name}" Visibility="{Binding IsRunning, Converter={StaticResource InvertedBooleanToVisibilityConverter}}" Style="{StaticResource SecondaryButtonStyle}" Padding="10,2"/>
                                            <Button Content="Detener" Command="{Binding DataContext.StopServiceCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}" CommandParameter="{Binding Name}" Visibility="{Binding IsRunning, Converter={StaticResource BooleanToVisibilityConverter}}" Style="{StaticResource DangerButtonStyle}" Padding="10,2"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Border>
            </TabItem>

            <!-- Inicio -->
            <TabItem Header="Inicio (Startup)">
                <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="0,12,12,12" Padding="15">
                    <DataGrid ItemsSource="{Binding StartupItems}" AutoGenerateColumns="False" Background="Transparent" Foreground="{DynamicResource TextBrush}" BorderThickness="0" CanUserAddRows="False"
                              VirtualizingStackPanel.IsVirtualizing="True" VirtualizingStackPanel.VirtualizationMode="Recycling">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Aplicación" Binding="{Binding Name}" Width="*"/>
                            <DataGridTextColumn Header="Impacto" Binding="{Binding ImpactScore, StringFormat={}{0:F1}}" Width="100"/>
                            <DataGridTemplateColumn Header="Estado" Width="120">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <Button Content="Habilitar" Command="{Binding DataContext.EnableStartupItemCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}" CommandParameter="{Binding}" Visibility="{Binding IsEnabled, Converter={StaticResource InvertedBooleanToVisibilityConverter}}" Style="{StaticResource SecondaryButtonStyle}" Padding="10,2"/>
                                            <Button Content="Deshabilitar" Command="{Binding DataContext.DisableStartupItemCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}" CommandParameter="{Binding}" Visibility="{Binding IsEnabled, Converter={StaticResource BooleanToVisibilityConverter}}" Style="{StaticResource DangerButtonStyle}" Padding="10,2"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Border>
            </TabItem>

            <!-- Métricas avanzadas -->
            <TabItem Header="Métricas Avanzadas">
                <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="0,12,12,12" Padding="15">
                    <StackPanel>
                        <TextBlock Text="CPU por núcleo" Foreground="{DynamicResource TextBrush}" FontWeight="SemiBold" Margin="0,0,0,8"/>
                        <ItemsControl ItemsSource="{Binding CpuPerCore}" AlternationCount="256">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Grid Margin="0,4">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="40"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="60"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Grid.Column="0" Foreground="{DynamicResource SecondaryTextBrush}"
                                                   Text="{Binding RelativeSource={RelativeSource Mode=FindAncestor, AncestorType=ContentPresenter}, Path=(ItemsControl.AlternationIndex), StringFormat={}{0}}"/>
                                        <ProgressBar Grid.Column="1" Value="{Binding}" Maximum="100" Height="10" Margin="10,0,10,0" Background="{DynamicResource WindowBackgroundBrush}"/>
                                        <TextBlock Grid.Column="2" Text="{Binding StringFormat={}{0:F0}%}" HorizontalAlignment="Right"/>
                                    </Grid>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <Separator Margin="0,12,0,12" Opacity="0.2"/>

                        <TextBlock Text="Red" Foreground="{DynamicResource TextBrush}" FontWeight="SemiBold" Margin="0,0,0,8"/>
                        <Grid Margin="0,4">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0" Text="{Binding NetRecvMbps, StringFormat={}{0:F2} Mbps ↓}" Foreground="{DynamicResource TextBrush}"/>
                            <TextBlock Grid.Column="1" Text="{Binding NetSentMbps, StringFormat={}{0:F2} Mbps ↑}" Foreground="{DynamicResource TextBrush}" HorizontalAlignment="Center"/>
                            <TextBlock Grid.Column="2" Text="{Binding ActiveTcpConnections, StringFormat={}{0} conexiones}" Foreground="{DynamicResource TextBrush}" HorizontalAlignment="Right"/>
                        </Grid>

                        <Separator Margin="0,12,0,12" Opacity="0.2"/>

                        <TextBlock Text="Disco" Foreground="{DynamicResource TextBrush}" FontWeight="SemiBold" Margin="0,0,0,8"/>
                        <Grid Margin="0,4">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <TextBlock Grid.Row="0" Text="{Binding DiskReadsPerSec, StringFormat={}{0:F0} lecturas/s}" Foreground="{DynamicResource TextBrush}"/>
                            <TextBlock Grid.Row="1" Text="{Binding DiskWritesPerSec, StringFormat={}{0:F0} escrituras/s}" Foreground="{DynamicResource TextBrush}"/>
                            <TextBlock Grid.Row="2" Text="{Binding DiskAvgQueueLength, StringFormat={}{0:F2} cola}" Foreground="{DynamicResource TextBrush}"/>
                        </Grid>
                        <Grid Margin="0,8,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0" Text="{Binding DiskReadLatencyMs, StringFormat={}{0:F2} ms lectura}" Foreground="{DynamicResource TextBrush}"/>
                            <TextBlock Grid.Column="1" Text="{Binding DiskWriteLatencyMs, StringFormat={}{0:F2} ms escritura}" Foreground="{DynamicResource TextBrush}" HorizontalAlignment="Right"/>
                        </Grid>
                    </StackPanel>
                </Border>
            </TabItem>
        </TabControl>
    </Grid>
</UserControl>
